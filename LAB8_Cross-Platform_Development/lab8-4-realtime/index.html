<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Wallboard - Real-time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }

        body[data-theme="light"] {
            background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
            color: #2c3e50;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .widget {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body[data-theme="light"] .widget {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .widget h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            text-align: center;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }

        .clock {
            font-size: 2em;
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-available {
            background: #2ecc71;
        }

        .status-busy {
            background: #e74c3c;
        }

        .status-break {
            background: #f39c12;
        }

        .status-offline {
            background: #95a5a6;
        }

        .agent-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body[data-theme="light"] .agent-item {
            background: rgba(0, 0, 0, 0.1);
        }

        .button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        body[data-theme="light"] .button {
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid #2c3e50;
            color: #2c3e50;
        }

        .button:hover {
            background: white;
            color: #3498db;
        }

        body[data-theme="light"] .button:hover {
            background: #2c3e50;
            color: white;
        }

        .loading {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
        }

        .error {
            color: #e74c3c;
            font-size: 0.9em;
        }

        .websocket-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .ws-connected {
            background: rgba(46, 204, 113, 0.3);
        }

        .ws-disconnected {
            background: rgba(231, 76, 60, 0.3);
        }

        .ws-connecting {
            background: rgba(243, 156, 18, 0.3);
        }

        body[data-theme="light"] .ws-connected {
            background: rgba(46, 204, 113, 0.1);
        }

        body[data-theme="light"] .ws-disconnected {
            background: rgba(231, 76, 60, 0.1);
        }

        body[data-theme="light"] .ws-connecting {
            background: rgba(243, 156, 18, 0.1);
        }
    </style>
</head>

<body data-theme="dark">
    <div class="dashboard">
        <!-- Header -->
        <div class="header widget">
            <h1>üè¢ Agent Wallboard Dashboard</h1>
            <p>Real-time Monitoring System</p>
            <div class="clock" id="liveClock">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...</div>
            <button class="button" id="themeToggle" onclick="toggleTheme()">üåô Dark Mode</button>
        </div>

        <!-- Weather Widget -->
        <div class="widget">
            <h3>üå§Ô∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
            <div id="weatherInfo" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button class="button" onclick="refreshWeather()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>

        <!-- System Status -->
        <div class="widget">
            <h3>‚ö° WebSocket Status</h3>
            <div id="websocketStatus" class="websocket-status ws-disconnected">
                üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            </div>
            <button class="button" onclick="connectWebSocket()">üîå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
            <button class="button" onclick="sendTestMessage()">üí¨ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <!-- Real-time Clock -->
        <div class="widget">
            <h3>üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å API</h3>
            <div id="apiTime" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button class="button" onclick="refreshTime()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>

        <!-- Agents List -->
        <div class="widget" style="grid-column: span 2;">
            <h3>üë• Agent Status (Mock Data)</h3>
            <div id="agentsList" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ agents...</div>
            <button class="button" onclick="refreshAgents()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Agents</button>
            <button class="button" onclick="startAutoRefresh()">‚è∞ Auto Refresh</button>
            <button class="button" onclick="stopAutoRefresh()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î Auto</button>
        </div>
        <!-- Agent Simulator Widget -->
        <div class="widget">
            <h3>üé≠ Agent Status Simulator</h3>
            <p>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö real-time</p>

            <button class="button" onclick="startSimulator()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° Simulator</button>
            <button class="button" onclick="stopSimulator()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î Simulator</button>

            <div id="simulatorStatus" style="margin-top: 15px;">
                üìç Simulator ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            </div>

            <div id="lastStatusChange" style="margin-top: 10px; font-size: 0.9em;">
                ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á...
            </div>
        </div>
        <div class="widget">
            <h3>üìä Agent Status Chart</h3>
            <canvas id="agentStatusChart" width="400" height="200"></canvas>
            <button class="button" onclick="updateCharts()">üîÑ Update Charts</button>
        </div>
        <div class="widget">
            <h3>üìà Call Volume Chart</h3>
            <canvas id="callVolumeChart" width="400" height="200"></canvas>
        </div>
        <div class="widget">
            <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ Metrics</h3>
            <div id="metricsInfo" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button class="button" onclick="refreshMetrics()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Metrics</button>
        </div>
        <div class="widget">
            <h3>üîî Notification Settings</h3>
            <div id="notificationStatus" style="margin-bottom: 15px;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
            </div>
            <button class="button" onclick="requestNotificationPermission()">üîî test Notification</button>
            <button class="button" onclick="testNotification()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Notification</button>
            <div style="margin-top: 10px;">
                <label>
                    <input type="checkbox" id="enableNotifications" checked> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Notifications
                </label>
            </div>
        </div>
        <!-- Settings Widget -->
        <div class="widget">
            <h3>üíæ Settings</h3>
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="number" id="refreshInterval" min="5" max="300" value="30" style="width: 60px;">
                    Auto Refresh Interval (seconds)
                </label>
            </div>
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="enableSounds" checked> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                </label>
            </div>
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="enableAnimations" checked> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Animations
                </label>
            </div>
            <button class="button" onclick="saveSettings()">üíæ Save Settings</button>
            <button class="button" onclick="loadSettings()">üìÇ Load Settings</button>
            <button class="button" onclick="resetSettings()">üîÑ Reset to Default</button>
            <div id="settingsStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        console.log('üé® [RENDERER] Real-time Dashboard ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');

        // Global variables
        let websocket = null;
        let autoRefreshInterval = null;
        let clockInterval = null;
        let notificationPermission = null;

        // ===== WEBSOCKET FUNCTIONS =====

        function connectWebSocket() {
            try {
                console.log('‚ö° [RENDERER] ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...');
                updateWebSocketStatus('connecting', 'üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');

                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket Echo Test
                websocket = new WebSocket('wss://echo.websocket.org/');

                websocket.onopen = function (event) {
                    console.log('‚úÖ [RENDERER] WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
                    updateWebSocketStatus('connected', 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');

                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
                    websocket.send(JSON.stringify({
                        type: 'wallboard_connected',
                        message: 'Agent Wallboard ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
                        timestamp: new Date().toISOString()
                    }));
                };

                websocket.onmessage = function (event) {
                    console.log('üì® [RENDERER] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:', event.data);

                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.log('üì® [RENDERER] Text message:', event.data);
                    }
                };

                websocket.onclose = function (event) {
                    console.log('üî¥ [RENDERER] WebSocket ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                    updateWebSocketStatus('disconnected', 'üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                    websocket = null;
                };

                websocket.onerror = function (error) {
                    console.error('‚ùå [RENDERER] WebSocket error:', error);
                    updateWebSocketStatus('disconnected', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                };

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
                updateWebSocketStatus('disconnected', '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
            }
        }

        function sendTestMessage() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'agent_status_update',
                    agentId: 'AG001',
                    newStatus: 'Available',
                    timestamp: new Date().toISOString(),
                    message: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Agent Wallboard'
                };

                console.log('üí¨ [RENDERER] ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö...');
                websocket.send(JSON.stringify(testMessage));
            } else {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket ‡∏Å‡πà‡∏≠‡∏ô');
            }
        }

        function updateWebSocketStatus(status, message) {
            const statusEl = document.getElementById('websocketStatus');
            statusEl.className = `websocket-status ws-${status}`;
            statusEl.textContent = message;
        }

        function handleWebSocketMessage(data) {
            console.log('üîÑ [RENDERER] ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:', data);

            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó agent status ‡πÅ‡∏ö‡∏ö real-time
            if (data.type === 'agent_status_update') {
                showNotification(`üîÑ ${data.agentId} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${data.newStatus}`);
            }
        }

        // ===== API FUNCTIONS =====

        async function refreshTime() {
            try {
                console.log('üïí [RENDERER] ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏ß‡∏•‡∏≤...');
                document.getElementById('apiTime').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

                const timeData = await window.realtimeAPI.getWorldTime();

                if (timeData && timeData.success) {
                    document.getElementById('apiTime').innerHTML = `
                <strong>üïí ${timeData.formatted}</strong><br>
                <small>Timezone: ${timeData.timezone}</small>
            `;
                } else {
                    // Fallback data
                    const fallbackTime = new Date().toLocaleString('th-TH');
                    document.getElementById('apiTime').innerHTML = `
                <div class="error">‚ùå ${timeData?.error || 'API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á'}</div>
                <div>Fallback: ${fallbackTime}</div>
            `;
                }

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
                // Fallback data
                const fallbackTime = new Date().toLocaleString('th-TH');
                document.getElementById('apiTime').innerHTML = `<div class="error">‚ùå ${error.message}</div><div>Fallback: ${fallbackTime}</div>`;
            }
        }

        async function refreshWeather() {
            try {
                console.log('üå§Ô∏è [RENDERER] ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®...');
                document.getElementById('weatherInfo').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

                const weatherData = await window.realtimeAPI.getWeather();

                if (weatherData && weatherData.success) {
                    document.getElementById('weatherInfo').innerHTML = `
                <strong>üìç ${weatherData.location}</strong><br>
                üå°Ô∏è ${weatherData.temperature}<br>
                ‚òÅÔ∏è ${weatherData.description}<br>
                üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${weatherData.humidity}
            `;
                } else {
                    // Fallback data
                    const fallback = weatherData?.fallback || {
                        location: 'Bangkok',
                        temperature: '30¬∞C',
                        description: 'Clear sky',
                        humidity: '60%'
                    };
                    document.getElementById('weatherInfo').innerHTML = `
                <div class="error">‚ö†Ô∏è ${weatherData?.error || 'API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á'}</div>
                <div><strong>üìç ${fallback.location}</strong><br>
                üå°Ô∏è ${fallback.temperature}<br>
                ‚òÅÔ∏è ${fallback.description}<br>
                üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${fallback.humidity}</div>
            `;
                }

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
                // Fallback data
                document.getElementById('weatherInfo').innerHTML = `
            <div class="error">‚ùå ${error.message}</div>
            <div><strong>üìç Bangkok</strong><br>
            üå°Ô∏è 30¬∞C<br>
            ‚òÅÔ∏è Clear sky<br>
            üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: 60%</div>
        `;
            }
        }

        async function refreshAgents() {
            try {
                console.log('üë• [RENDERER] ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä agents...');
                document.getElementById('agentsList').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

                const agentData = await window.realtimeAPI.getMockAgents();

                if (agentData && agentData.success) {
                    let agentsHTML = '';
                    agentData.agents.forEach(agent => {
                        const statusClass = `status-${agent.status.toLowerCase()}`;
                        agentsHTML += `
                    <div class="agent-item">
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            <strong>${agent.name}</strong> (${agent.id})
                        </div>
                        <div>
                            ${agent.status} | Ext: ${agent.extension}
                        </div>
                    </div>
                `;
                    });

                    agentsHTML += `<div style="margin-top: 15px; font-size: 0.9em;">
                üìä Total: ${agentData.count} agents
                ${agentData.fallback ? ' (Fallback data)' : ' (Live from API)'}
            </div>`;

                    document.getElementById('agentsList').innerHTML = agentsHTML;
                } else {
                    // Fallback data
                    const fallbackAgents = [
                        { id: 'AG001', name: 'Agent One', status: 'Available', extension: '1001' },
                        { id: 'AG002', name: 'Agent Two', status: 'Busy', extension: '1002' },
                        { id: 'AG003', name: 'Agent Three', status: 'Break', extension: '1003' }
                    ];
                    let agentsHTML = '';
                    fallbackAgents.forEach(agent => {
                        const statusClass = `status-${agent.status.toLowerCase()}`;
                        agentsHTML += `
                    <div class="agent-item">
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            <strong>${agent.name}</strong> (${agent.id})
                        </div>
                        <div>
                            ${agent.status} | Ext: ${agent.extension}
                        </div>
                    </div>
                `;
                    });
                    agentsHTML += `<div style="margin-top: 15px; font-size: 0.9em;">
                üìä Total: ${fallbackAgents.length} agents (Fallback data)
            </div>`;
                    document.getElementById('agentsList').innerHTML = agentsHTML;
                }

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
                // Fallback data
                const fallbackAgents = [
                    { id: 'AG001', name: 'Agent One', status: 'Available', extension: '1001' },
                    { id: 'AG002', name: 'Agent Two', status: 'Busy', extension: '1002' },
                    { id: 'AG003', name: 'Agent Three', status: 'Break', extension: '1003' }
                ];
                let agentsHTML = '';
                fallbackAgents.forEach(agent => {
                    const statusClass = `status-${agent.status.toLowerCase()}`;
                    agentsHTML += `
                <div class="agent-item">
                    <div>
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${agent.name}</strong> (${agent.id})
                    </div>
                    <div>
                        ${agent.status} | Ext: ${agent.extension}
                    </div>
                </div>
            `;
                });
                agentsHTML += `<div style="margin-top: 15px; font-size: 0.9em;">
            üìä Total: ${fallbackAgents.length} agents (Fallback data)
        </div>`;
                document.getElementById('agentsList').innerHTML = agentsHTML;
            }
        }

        // ===== SIMULATOR FUNCTIONS =====

        async function startSimulator() {
            try {
                console.log('üé≠ [RENDERER] ‡πÄ‡∏£‡∏¥‡πà‡∏° simulator...');

                const result = await window.realtimeAPI.startSimulator();

                if (result.success) {
                    document.getElementById('simulatorStatus').innerHTML = 'üü¢ Simulator ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà';
                    showNotification('üé≠ Agent Status Simulator ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                }

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
            }
        }

        async function stopSimulator() {
            try {
                console.log('‚èπÔ∏è [RENDERER] ‡∏´‡∏¢‡∏∏‡∏î simulator...');

                const result = await window.realtimeAPI.stopSimulator();

                if (result.success) {
                    document.getElementById('simulatorStatus').innerHTML = 'üî¥ Simulator ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                    showNotification('‚èπÔ∏è Agent Status Simulator ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                }

            } catch (error) {
                console.error('‚ùå [RENDERER] Error:', error);
            }
        }

        // ‡∏£‡∏±‡∏ö event ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å simulator
        window.realtimeAPI.onAgentStatusChanged((data) => {
            console.log('üì° [RENDERER] Agent status changed:', data);

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
            document.getElementById('lastStatusChange').innerHTML = `
    üîÑ <strong>${data.agentId}</strong> ‚Üí ${data.newStatus}<br>
    <small>‚è∞ ${new Date(data.timestamp).toLocaleTimeString('th-TH')}</small>
  `;

            // ‡πÅ‡∏™‡∏î‡∏á notification
            showNotification(`üîÑ ${data.agentId} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${data.newStatus}`);

            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä agents list
            refreshAgents();
        });

        async function refreshMetrics() {
            try {
                document.getElementById('metricsInfo').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
                // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏î‡∏∂‡∏á metrics ‡∏à‡∏≤‡∏Å API (‡∏´‡∏£‡∏∑‡∏≠ mock)
                const metricsData = await (window.realtimeAPI.getMetrics?.() || Promise.resolve({
                    success: false
                }));

                if (metricsData && metricsData.success) {
                    document.getElementById('metricsInfo').innerHTML = `
                <strong>Agents Online:</strong> ${metricsData.agentsOnline}<br>
                <strong>Agents Busy:</strong> ${metricsData.agentsBusy}<br>
                <strong>Agents on Break:</strong> ${metricsData.agentsBreak}<br>
                <strong>Average Response Time:</strong> ${metricsData.avgResponseTime} sec
            `;
                } else {
                    // fallback metrics
                    document.getElementById('metricsInfo').innerHTML = `
                <div class="error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Metrics ‡πÑ‡∏î‡πâ</div>
                <div>
                    <strong>Agents Online:</strong> 2<br>
                    <strong>Agents Busy:</strong> 1<br>
                    <strong>Agents on Break:</strong> 1<br>
                    <strong>Average Response Time:</strong> 15 sec
                </div>
            `;
                }
            } catch (error) {
                document.getElementById('metricsInfo').innerHTML = `
            <div class="error">‚ùå ${error.message}</div>
            <div>
                <strong>Agents Online:</strong> 2<br>
                <strong>Agents Busy:</strong> 1<br>
                <strong>Agents on Break:</strong> 1<br>
                <strong>Average Response Time:</strong> 15 sec
            </div>
        `;
            }
        }

        // ===== CHART FUNCTIONS =====

        let agentStatusChart = null;
        let callVolumeChart = null;

        function initializeCharts() {
            // Agent Status Pie Chart
            const statusCtx = document.getElementById('agentStatusChart').getContext('2d');
            agentStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Busy', 'Break', 'Offline'],
                    datasets: [{
                        data: [3, 2, 1, 1],
                        backgroundColor: [
                            '#2ecc71', // Available - Green
                            '#e74c3c', // Busy - Red
                            '#f39c12', // Break - Orange
                            '#95a5a6'  // Offline - Gray
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            // Call Volume Line Chart
            const volumeCtx = document.getElementById('callVolumeChart').getContext('2d');
            callVolumeChart = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: 'Calls per Hour',
                        data: [12, 8, 25, 45, 38, 22],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
        }

        async function updateCharts() {
            try {
                console.log('üìà [RENDERER] Updating charts...');
                
                // Get current agent data
                const agentData = await window.realtimeAPI.getMockAgents();
                
                if (agentData && agentData.success) {
                    // Count agents by status
                    const statusCounts = {
                        Available: 0,
                        Busy: 0,
                        Break: 0,
                        Offline: 0
                    };
                    
                    agentData.agents.forEach(agent => {
                        if (statusCounts.hasOwnProperty(agent.status)) {
                            statusCounts[agent.status]++;
                        }
                    });
                    
                    // Update pie chart
                    if (agentStatusChart) {
                        agentStatusChart.data.datasets[0].data = [
                            statusCounts.Available,
                            statusCounts.Busy,
                            statusCounts.Break,
                            statusCounts.Offline
                        ];
                        agentStatusChart.update();
                    }
                }
                
                // Update call volume with simulated data
                if (callVolumeChart) {
                    const newData = Array.from({length: 6}, () => Math.floor(Math.random() * 50) + 10);
                    callVolumeChart.data.datasets[0].data = newData;
                    callVolumeChart.update();
                }
                
                showNotification('üìà Charts updated successfully!');
                
            } catch (error) {
                console.error('‚ùå [RENDERER] Chart update error:', error);
            }
        }

        // ===== AUTO REFRESH FUNCTIONS =====

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            console.log('‚è∞ [RENDERER] ‡πÄ‡∏£‡∏¥‡πà‡∏° auto refresh...');

            // ‡πÉ‡∏ä‡πâ interval ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            const refreshInterval = parseInt(localStorage.getItem('refreshInterval') || '30') * 1000;

            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ [RENDERER] Auto refresh...');
                refreshAgents();
                refreshTime();
                updateCharts();
            }, refreshInterval);

            showNotification(`‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏° Auto Refresh ‡πÅ‡∏•‡πâ‡∏ß (‡∏ó‡∏∏‡∏Å ${refreshInterval/1000} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚èπÔ∏è [RENDERER] ‡∏´‡∏¢‡∏∏‡∏î auto refresh');
                showNotification('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î Auto Refresh ‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        // ===== THEME FUNCTIONS =====

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'üåô Dark Mode';
                localStorage.setItem('theme', 'light');
            }
            
            // Update charts colors if they exist
            updateChartsTheme();
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            body.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'light') {
                themeToggle.textContent = 'üåô Dark Mode';
            } else {
                themeToggle.textContent = '‚òÄÔ∏è Light Mode';
            }
        }

        function updateChartsTheme() {
            const isDark = document.body.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#fff' : '#2c3e50';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            if (agentStatusChart) {
                agentStatusChart.options.plugins.legend.labels.color = textColor;
                agentStatusChart.update();
            }
            
            if (callVolumeChart) {
                callVolumeChart.options.scales.x.ticks.color = textColor;
                callVolumeChart.options.scales.y.ticks.color = textColor;
                callVolumeChart.options.scales.x.grid.color = gridColor;
                callVolumeChart.options.scales.y.grid.color = gridColor;
                callVolumeChart.options.plugins.legend.labels.color = textColor;
                callVolumeChart.update();
            }
        }

        // ===== UTILITY FUNCTIONS =====

        function updateLiveClock() {
            const now = new Date();
            document.getElementById('liveClock').textContent = now.toLocaleString('th-TH');
        }

        function showNotification(message) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ notifications ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const enableNotifications = document.getElementById('enableNotifications')?.checked;
            if (!enableNotifications) {
                console.log('üîî [NOTIFICATION DISABLED]', message);
                return;
            }

            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥‡πÅ‡∏™‡∏î‡∏á notification
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission;
                    updateNotificationStatus();
                    if (permission === 'granted') {
                        // ‡πÅ‡∏™‡∏î‡∏á notification
                        new Notification('Agent Wallboard', {
                            body: message,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%233498db"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="30">üè¢</text></svg>',
                            tag: 'agent-status'
                        });
                    }
                });
            } else if (Notification.permission === 'granted') {
                // ‡πÅ‡∏™‡∏î‡∏á notification
                new Notification('Agent Wallboard', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%233498db"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="30">üè¢</text></svg>',
                    tag: 'agent-status'
                });
            } else {
                console.log('üîî [NOTIFICATION BLOCKED]', message);
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission;
                    updateNotificationStatus();
                    if (permission === 'granted') {
                        showNotification('‚úÖ Notification permission granted!');
                    }
                });
            } else {
                alert('‚ùå Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Notifications');
            }
        }

        function testNotification() {
            showNotification('üß™ ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Notification - Agent AG001 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Available');
        }

        function updateNotificationStatus() {
            const statusEl = document.getElementById('notificationStatus');
            if (!('Notification' in window)) {
                statusEl.innerHTML = '‚ùå Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Notifications';
                statusEl.style.color = '#e74c3c';
            } else if (Notification.permission === 'granted') {
                statusEl.innerHTML = '‚úÖ Notifications';
                statusEl.style.color = '#2ecc71';
            } else if (Notification.permission === 'denied') {
                statusEl.innerHTML = '‚ùå Notifications ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
                statusEl.style.color = '#e74c3c';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥ Notifications';
                statusEl.style.color = '#f39c12';
            }
        }

        // ===== SETTINGS FUNCTIONS =====

        function saveSettings() {
            const refreshInterval = parseInt(document.getElementById('refreshInterval').value);
            const enableSounds = document.getElementById('enableSounds').checked;
            const enableAnimations = document.getElementById('enableAnimations').checked;

            localStorage.setItem('refreshInterval', refreshInterval);
            localStorage.setItem('enableSounds', enableSounds);
            localStorage.setItem('enableAnimations', enableAnimations);

            showNotification('üíæ Settings saved successfully!');
        }

        function loadSettings() {
            const refreshInterval = localStorage.getItem('refreshInterval');
            const enableSounds = localStorage.getItem('enableSounds');
            const enableAnimations = localStorage.getItem('enableAnimations');

            if (refreshInterval) {
                document.getElementById('refreshInterval').value = refreshInterval;
            }

            if (enableSounds === 'true') {
                document.getElementById('enableSounds').checked = true;
            } else {
                document.getElementById('enableSounds').checked = false;
            }

            if (enableAnimations === 'true') {
                document.getElementById('enableAnimations').checked = true;
            } else {
                document.getElementById('enableAnimations').checked = false;
            }

            showNotification('üìÇ Settings loaded successfully!');
        }

        function resetSettings() {
            localStorage.removeItem('refreshInterval');
            localStorage.removeItem('enableSounds');
            localStorage.removeItem('enableAnimations');

            document.getElementById('refreshInterval').value = 30;
            document.getElementById('enableSounds').checked = true;
            document.getElementById('enableAnimations').checked = true;

            showNotification('üîÑ Settings reset to default!');
        }

        // ===== INITIALIZATION =====

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ [RENDERER] DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß');

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô live clock
            clockInterval = setInterval(updateLiveClock, 1000);
            updateLiveClock();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ notification
            updateNotificationStatus();

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            loadSettings();

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            refreshTime();
            refreshWeather();
            refreshAgents();
            refreshMetrics();

            initializeCharts();
            initializeTheme();

            console.log('‚úÖ [RENDERER] Dashboard ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        });

        // Cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î window
        window.addEventListener('beforeunload', () => {
            console.log('üîÑ [RENDERER] ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î...');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            if (clockInterval) {
                clearInterval(clockInterval);
            }

            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>

</html>